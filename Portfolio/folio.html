<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Journal</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a24;
            --bg-hover: #242432;
            --text-primary: #e8e8ed;
            --text-secondary: #8888a0;
            --text-muted: #555566;
            --green: #00d26a;
            --green-dim: rgba(0, 210, 106, 0.15);
            --red: #ff4757;
            --red-dim: rgba(255, 71, 87, 0.15);
            --gray: #2a2a3a;
            --border: #2a2a3a;
            --accent: #6366f1;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

                /* Password Screen */
        .password-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .password-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 3rem;
            text-align: center;
            max-width: 360px;
            width: 90%;
        }

        .password-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .password-box h2 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .password-box p {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 1.5rem;
        }

        .password-box input {
            width: 100%;
            padding: 0.875rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1rem;
            text-align: center;
            margin-bottom: 1rem;
        }

        .password-box input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .password-box button {
            width: 100%;
            padding: 0.875rem 1.5rem;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            color: white;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .password-box button:hover {
            opacity: 0.9;
        }

        .password-error {
            color: var(--red) !important;
            margin-top: 1rem;
            margin-bottom: 0 !important;
            min-height: 1.25rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--border);
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            margin-bottom: 1.5rem;
        }

        .running-total {
            display: inline-flex;
            align-items: center;
            gap: 1rem;
            background: var(--bg-card);
            padding: 1rem 2rem;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .running-total-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .running-total-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2rem;
            font-weight: 700;
        }

        .running-total-value.positive { color: var(--green); }
        .running-total-value.negative { color: var(--red); }

        /* Navigation */
        .nav {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .nav-btn {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.875rem;
            font-weight: 500;
            padding: 0.75rem 1.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .nav-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        /* Views Container */
        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* Month/Week Navigation */
        .view-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .view-nav button {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.25rem;
            padding: 0.5rem 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .view-nav button:hover {
            background: var(--bg-hover);
        }

        .view-nav span {
            font-size: 1.25rem;
            font-weight: 600;
            min-width: 200px;
            text-align: center;
        }

        /* Calendar Grid */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            background: var(--bg-card);
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .calendar-header {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-align: center;
            padding: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 0.5rem;
            min-height: 70px;
            position: relative;
            transition: transform 0.2s;
        }

        .calendar-day:hover {
            transform: scale(1.05);
        }

        .calendar-day.empty {
            background: transparent;
        }

        .calendar-day.no-entry {
            background: var(--gray);
        }

        .calendar-day.positive {
            background: var(--green-dim);
            border: 1px solid var(--green);
        }

        .calendar-day.negative {
            background: var(--red-dim);
            border: 1px solid var(--red);
        }

        .calendar-day.weekend {
            opacity: 0.4;
        }

        .day-number {
            font-size: 0.75rem;
            color: var(--text-secondary);
            position: absolute;
            top: 4px;
            left: 6px;
        }

        .day-pnl {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .calendar-day.positive .day-pnl { color: var(--green); }
        .calendar-day.negative .day-pnl { color: var(--red); }

        /* Weekly View */
        .weekly-grid {
            background: var(--bg-card);
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .week-row {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 8px;
        }

        .week-row:last-child {
            margin-bottom: 0;
        }

        .week-day-header {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-align: center;
            padding: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .week-day {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            transition: transform 0.2s;
        }

        .week-day:hover {
            transform: scale(1.02);
        }

        .week-day.no-entry {
            background: var(--gray);
        }

        .week-day.positive {
            background: var(--green-dim);
            border: 1px solid var(--green);
        }

        .week-day.negative {
            background: var(--red-dim);
            border: 1px solid var(--red);
        }

        .week-day-date {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .week-day-pnl {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .week-day.positive .week-day-pnl { color: var(--green); }
        .week-day.negative .week-day-pnl { color: var(--red); }

        .week-day-notes {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .week-total {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
            text-align: center;
        }

        .week-total-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .week-total-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .week-total-value.positive { color: var(--green); }
        .week-total-value.negative { color: var(--red); }

        /* Heat Map */
        .heatmap-container {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow-x: auto;
        }

        .heatmap-year {
            margin-bottom: 2rem;
        }

        .heatmap-year:last-child {
            margin-bottom: 0;
        }

        .heatmap-year-label {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-secondary);
        }

        .heatmap-grid {
            display: flex;
            gap: 3px;
        }

        .heatmap-week {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .heatmap-day {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            background: var(--gray);
            cursor: pointer;
            transition: transform 0.1s;
        }

        .heatmap-day:hover {
            transform: scale(1.5);
        }

        .heatmap-day.positive-1 { background: rgba(0, 210, 106, 0.3); }
        .heatmap-day.positive-2 { background: rgba(0, 210, 106, 0.5); }
        .heatmap-day.positive-3 { background: rgba(0, 210, 106, 0.7); }
        .heatmap-day.positive-4 { background: var(--green); }

        .heatmap-day.negative-1 { background: rgba(255, 71, 87, 0.3); }
        .heatmap-day.negative-2 { background: rgba(255, 71, 87, 0.5); }
        .heatmap-day.negative-3 { background: rgba(255, 71, 87, 0.7); }
        .heatmap-day.negative-4 { background: var(--red); }

        .heatmap-legend {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1.5rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .heatmap-legend-box {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .heatmap-tooltip {
            position: fixed;
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            pointer-events: none;
            z-index: 1000;
            display: none;
        }

        /* Reports */
        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        .report-card {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .report-card h3 {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .report-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
        }

        .report-item:last-child {
            border-bottom: none;
        }

        .report-item-label {
            font-size: 0.875rem;
            color: var(--text-primary);
        }

        .report-item-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            font-weight: 600;
        }

        .report-item-value.positive { color: var(--green); }
        .report-item-value.negative { color: var(--red); }

        /* Config Panel */
        .config-panel {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-bottom: 2rem;
        }

        .config-panel label {
            display: block;
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .config-panel input {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
        }

        .config-panel input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .config-panel button {
            margin-top: 1rem;
            padding: 0.75rem 1.5rem;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            color: white;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .config-panel button:hover {
            opacity: 0.9;
        }

        .config-note {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        /* Loading & Error States */
        .loading, .error {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .error {
            color: var(--red);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .running-total {
                flex-direction: column;
                gap: 0.5rem;
                padding: 1rem;
            }

            .running-total-value {
                font-size: 1.5rem;
            }

            .calendar-day {
                min-height: 50px;
                padding: 0.25rem;
            }

            .day-pnl {
                font-size: 0.7rem;
            }

            .nav-btn {
                padding: 0.5rem 1rem;
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <!-- Password Screen -->
    <div class="password-screen" id="passwordScreen">
        <div class="password-box">
            <div class="password-icon">üîê</div>
            <h2>Trading Journal</h2>
            <p>Enter password to continue</p>
            <input type="password" id="passwordInput" placeholder="Password" onkeypress="if(event.key==='Enter')checkPassword()">
            <button onclick="checkPassword()">Unlock</button>
            <p class="password-error" id="passwordError"></p>
        </div>
    </div>

    <div class="container" id="mainContainer" style="display: none;">
        <!-- Config Panel (shown when no URL is set) -->
        <div class="config-panel" id="configPanel">
            <label for="sheetUrl">Google Sheet CSV URL</label>
            <input type="text" id="sheetUrl" placeholder="https://docs.google.com/spreadsheets/d/e/2PACX-.../pub?output=csv">
            <p class="config-note">
                Go to your Google Sheet ‚Üí File ‚Üí Share ‚Üí Publish to web ‚Üí Select CSV ‚Üí Copy the URL
            </p>
            <button onclick="saveAndLoad()">Load Data</button>
        </div>

        <!-- Main App (hidden until data loads) -->
        <div id="mainApp" style="display: none;">
            <!-- Header -->
            <div class="header">
                <h1>üìà Trading Journal</h1>
                <div class="running-total">
                    <span class="running-total-label">Running P&L</span>
                    <span class="running-total-value" id="runningTotal">$0</span>
                </div>
            </div>

            <!-- Navigation -->
            <div class="nav">
                <button class="nav-btn active" data-view="monthly">Monthly</button>
                <button class="nav-btn" data-view="weekly">Weekly</button>
                <button class="nav-btn" data-view="heatmap">Heat Map</button>
                <button class="nav-btn" data-view="reports">Reports</button>
            </div>

            <!-- Monthly View -->
            <div class="view active" id="monthlyView">
                <div class="view-nav">
                    <button onclick="changeMonth(-1)">‚óÄ</button>
                    <span id="monthLabel">January 2025</span>
                    <button onclick="changeMonth(1)">‚ñ∂</button>
                </div>
                <div class="calendar-grid" id="monthlyCalendar"></div>
            </div>

            <!-- Weekly View -->
            <div class="view" id="weeklyView">
                <div class="view-nav">
                    <button onclick="changeWeek(-1)">‚óÄ</button>
                    <span id="weekLabel">Jan 6 - Jan 10, 2025</span>
                    <button onclick="changeWeek(1)">‚ñ∂</button>
                </div>
                <div class="weekly-grid" id="weeklyGrid"></div>
            </div>

            <!-- Heat Map View -->
            <div class="view" id="heatmapView">
                <div class="heatmap-container" id="heatmapContainer"></div>
            </div>

            <!-- Reports View -->
            <div class="view" id="reportsView">
                <div class="reports-grid" id="reportsGrid"></div>
            </div>
        </div>

        <!-- Tooltip for heatmap -->
        <div class="heatmap-tooltip" id="tooltip"></div>
    </div>

    <script>
        // Password hash (SHA-256 of the password)
        const PASSWORD_HASH = 'e166e2eed5e1f915d03791e74c04c725a5465964b4abf96fa3956d3bc0025445';

        // SHA-256 hash function
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        // Check password
        async function checkPassword() {
            const input = document.getElementById('passwordInput').value;
            const hash = await sha256(input);
            
            if (hash === PASSWORD_HASH) {
                document.getElementById('passwordScreen').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'block';
                sessionStorage.setItem('tj_authenticated', 'true');
                init();
            } else {
                document.getElementById('passwordError').textContent = 'Incorrect password';
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordInput').focus();
            }
        }

        // Check if already authenticated this session
        if (sessionStorage.getItem('tj_authenticated') === 'true') {
            document.getElementById('passwordScreen').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'block';
        } else {
            document.getElementById('passwordInput').focus();
        }

        // State
        let pnlData = {};
        let currentMonth = new Date();
        let currentWeek = new Date();

        // Format currency
        function formatCurrency(value) {
            const absValue = Math.abs(value);
            const formatted = absValue.toLocaleString('en-US', { 
                style: 'currency', 
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
            return value < 0 ? '-' + formatted : formatted;
        }

        // Parse date from MM/DD/YYYY format
        function parseDate(dateStr) {
            if (!dateStr) return null;
            const parts = dateStr.trim().split('/');
            if (parts.length !== 3) return null;
            const month = parseInt(parts[0], 10) - 1;
            const day = parseInt(parts[1], 10);
            const year = parseInt(parts[2], 10);
            if (isNaN(month) || isNaN(day) || isNaN(year)) return null;
            return new Date(year, month, day);
        }

        // Format date as key
        function dateKey(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        // Load data from Google Sheet
        async function loadData(url) {
            try {
                // Use CORS proxy for local file access
                const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(url);
                const response = await fetch(proxyUrl);
                const text = await response.text();
                const lines = text.trim().split('\n');
                
                pnlData = {};
                
                // Skip header row
                for (let i = 1; i < lines.length; i++) {
                    const cols = parseCSVLine(lines[i]);
                    if (cols.length >= 2) {
                        const date = parseDate(cols[0]);
                        const pnl = parseFloat(cols[1].replace(/[$,]/g, ''));
                        const notes = cols[2] || '';
                        
                        if (date && !isNaN(pnl)) {
                            pnlData[dateKey(date)] = { pnl, notes };
                        }
                    }
                }
                
                return true;
            } catch (error) {
                console.error('Error loading data:', error);
                return false;
            }
        }

        // Parse CSV line (handle quoted fields)
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            
            return result;
        }

        // Calculate running total
        function calculateRunningTotal() {
            let total = 0;
            for (const key in pnlData) {
                total += pnlData[key].pnl;
            }
            return total;
        }

        // Render running total
        function renderRunningTotal() {
            const total = calculateRunningTotal();
            const el = document.getElementById('runningTotal');
            el.textContent = formatCurrency(total);
            el.className = 'running-total-value ' + (total >= 0 ? 'positive' : 'negative');
        }

        // Render monthly calendar
        function renderMonthlyCalendar() {
            const container = document.getElementById('monthlyCalendar');
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            
            // Update label
            document.getElementById('monthLabel').textContent = 
                currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            // Clear container
            container.innerHTML = '';
            
            // Add day headers
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            days.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-header';
                header.textContent = day;
                container.appendChild(header);
            });
            
            // Get first day of month and total days
            const firstDay = new Date(year, month, 1).getDay();
            const totalDays = new Date(year, month + 1, 0).getDate();
            
            // Add empty cells for days before first
            for (let i = 0; i < firstDay; i++) {
                const empty = document.createElement('div');
                empty.className = 'calendar-day empty';
                container.appendChild(empty);
            }
            
            // Add day cells
            for (let day = 1; day <= totalDays; day++) {
                const date = new Date(year, month, day);
                const key = dateKey(date);
                const data = pnlData[key];
                const dayOfWeek = date.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                
                const cell = document.createElement('div');
                cell.className = 'calendar-day';
                
                if (isWeekend) {
                    cell.classList.add('weekend');
                }
                
                if (data) {
                    cell.classList.add(data.pnl >= 0 ? 'positive' : 'negative');
                    cell.innerHTML = `
                        <span class="day-number">${day}</span>
                        <span class="day-pnl">${formatCurrency(data.pnl)}</span>
                    `;
                    if (data.notes) {
                        cell.title = data.notes;
                    }
                } else {
                    cell.classList.add('no-entry');
                    cell.innerHTML = `<span class="day-number">${day}</span>`;
                }
                
                container.appendChild(cell);
            }
        }

        // Get Monday of a week
        function getMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        // Render weekly view
        function renderWeeklyView() {
            const container = document.getElementById('weeklyGrid');
            const monday = getMonday(currentWeek);
            
            // Update label
            const friday = new Date(monday);
            friday.setDate(friday.getDate() + 4);
            document.getElementById('weekLabel').textContent = 
                `${monday.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${friday.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
            
            container.innerHTML = '';
            
            // Add headers
            const headerRow = document.createElement('div');
            headerRow.className = 'week-row';
            ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'].forEach(day => {
                const header = document.createElement('div');
                header.className = 'week-day-header';
                header.textContent = day;
                headerRow.appendChild(header);
            });
            container.appendChild(headerRow);
            
            // Add days
            const dayRow = document.createElement('div');
            dayRow.className = 'week-row';
            let weekTotal = 0;
            
            for (let i = 0; i < 5; i++) {
                const date = new Date(monday);
                date.setDate(date.getDate() + i);
                const key = dateKey(date);
                const data = pnlData[key];
                
                const cell = document.createElement('div');
                cell.className = 'week-day';
                
                if (data) {
                    cell.classList.add(data.pnl >= 0 ? 'positive' : 'negative');
                    weekTotal += data.pnl;
                    cell.innerHTML = `
                        <div class="week-day-date">${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>
                        <div class="week-day-pnl">${formatCurrency(data.pnl)}</div>
                        ${data.notes ? `<div class="week-day-notes" title="${data.notes}">${data.notes}</div>` : ''}
                    `;
                } else {
                    cell.classList.add('no-entry');
                    cell.innerHTML = `
                        <div class="week-day-date">${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>
                        <div class="week-day-pnl">‚Äî</div>
                    `;
                }
                
                dayRow.appendChild(cell);
            }
            container.appendChild(dayRow);
            
            // Add week total
            const totalDiv = document.createElement('div');
            totalDiv.className = 'week-total';
            totalDiv.innerHTML = `
                <div class="week-total-label">Week Total</div>
                <div class="week-total-value ${weekTotal >= 0 ? 'positive' : 'negative'}">${formatCurrency(weekTotal)}</div>
            `;
            container.appendChild(totalDiv);
        }

        // Get intensity level for heatmap (1-4)
        function getIntensity(value, maxAbs) {
            const absVal = Math.abs(value);
            const ratio = absVal / maxAbs;
            if (ratio > 0.75) return 4;
            if (ratio > 0.5) return 3;
            if (ratio > 0.25) return 2;
            return 1;
        }

        // Render heat map
        function renderHeatmap() {
            const container = document.getElementById('heatmapContainer');
            container.innerHTML = '';
            
            // Get all dates and find range
            const dates = Object.keys(pnlData).sort();
            if (dates.length === 0) {
                container.innerHTML = '<p class="loading">No data available</p>';
                return;
            }
            
            // Find max absolute value for scaling
            let maxAbs = 0;
            for (const key in pnlData) {
                maxAbs = Math.max(maxAbs, Math.abs(pnlData[key].pnl));
            }
            
            // Get year range
            const firstDate = new Date(dates[0]);
            const lastDate = new Date(dates[dates.length - 1]);
            const startYear = firstDate.getFullYear();
            const endYear = lastDate.getFullYear();
            
            // Render each year
            for (let year = endYear; year >= startYear; year--) {
                const yearDiv = document.createElement('div');
                yearDiv.className = 'heatmap-year';
                
                const label = document.createElement('div');
                label.className = 'heatmap-year-label';
                label.textContent = year;
                yearDiv.appendChild(label);
                
                const grid = document.createElement('div');
                grid.className = 'heatmap-grid';
                
                // Get first day of year and create weeks
                const yearStart = new Date(year, 0, 1);
                const yearEnd = new Date(year, 11, 31);
                
                let currentDate = new Date(yearStart);
                // Adjust to start on Sunday
                currentDate.setDate(currentDate.getDate() - currentDate.getDay());
                
                while (currentDate <= yearEnd || currentDate.getDay() !== 0) {
                    const weekDiv = document.createElement('div');
                    weekDiv.className = 'heatmap-week';
                    
                    for (let d = 0; d < 7; d++) {
                        const dayDiv = document.createElement('div');
                        dayDiv.className = 'heatmap-day';
                        
                        if (currentDate.getFullYear() === year) {
                            const key = dateKey(currentDate);
                            const data = pnlData[key];
                            
                            if (data) {
                                const intensity = getIntensity(data.pnl, maxAbs);
                                dayDiv.classList.add(data.pnl >= 0 ? `positive-${intensity}` : `negative-${intensity}`);
                                dayDiv.dataset.date = currentDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
                                dayDiv.dataset.pnl = formatCurrency(data.pnl);
                                dayDiv.dataset.notes = data.notes || '';
                            }
                        }
                        
                        weekDiv.appendChild(dayDiv);
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                    
                    grid.appendChild(weekDiv);
                    
                    if (currentDate.getFullYear() > year) break;
                }
                
                yearDiv.appendChild(grid);
                container.appendChild(yearDiv);
            }
            
            // Add legend
            const legend = document.createElement('div');
            legend.className = 'heatmap-legend';
            legend.innerHTML = `
                <span>Less</span>
                <div class="heatmap-legend-box" style="background: var(--red);"></div>
                <div class="heatmap-legend-box" style="background: rgba(255, 71, 87, 0.5);"></div>
                <div class="heatmap-legend-box" style="background: var(--gray);"></div>
                <div class="heatmap-legend-box" style="background: rgba(0, 210, 106, 0.5);"></div>
                <div class="heatmap-legend-box" style="background: var(--green);"></div>
                <span>More</span>
            `;
            container.appendChild(legend);
            
            // Add tooltip handlers
            const tooltip = document.getElementById('tooltip');
            container.querySelectorAll('.heatmap-day').forEach(day => {
                day.addEventListener('mouseenter', (e) => {
                    if (day.dataset.date) {
                        tooltip.innerHTML = `
                            <strong>${day.dataset.date}</strong><br>
                            ${day.dataset.pnl}
                            ${day.dataset.notes ? '<br><em>' + day.dataset.notes + '</em>' : ''}
                        `;
                        tooltip.style.display = 'block';
                        tooltip.style.left = e.pageX + 10 + 'px';
                        tooltip.style.top = e.pageY + 10 + 'px';
                    }
                });
                day.addEventListener('mouseleave', () => {
                    tooltip.style.display = 'none';
                });
            });
        }

        // Render reports
        function renderReports() {
            const container = document.getElementById('reportsGrid');
            container.innerHTML = '';
            
            // Calculate weekly stats
            const weeklyStats = {};
            const monthlyStats = {};
            const yearlyStats = {};
            
            for (const key in pnlData) {
                const date = new Date(key);
                const pnl = pnlData[key].pnl;
                
                // Weekly (using Monday as week start)
                const monday = getMonday(date);
                const weekKey = dateKey(monday);
                weeklyStats[weekKey] = (weeklyStats[weekKey] || 0) + pnl;
                
                // Monthly
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                monthlyStats[monthKey] = (monthlyStats[monthKey] || 0) + pnl;
                
                // Yearly
                const yearKey = date.getFullYear().toString();
                yearlyStats[yearKey] = (yearlyStats[yearKey] || 0) + pnl;
            }
            
            // Weekly Report
            const weeklyCard = document.createElement('div');
            weeklyCard.className = 'report-card';
            weeklyCard.innerHTML = '<h3>Weekly Performance</h3>';
            const weekKeys = Object.keys(weeklyStats).sort().reverse().slice(0, 10);
            weekKeys.forEach(key => {
                const date = new Date(key);
                const friday = new Date(date);
                friday.setDate(friday.getDate() + 4);
                const label = `${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${friday.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
                const value = weeklyStats[key];
                weeklyCard.innerHTML += `
                    <div class="report-item">
                        <span class="report-item-label">${label}</span>
                        <span class="report-item-value ${value >= 0 ? 'positive' : 'negative'}">${formatCurrency(value)}</span>
                    </div>
                `;
            });
            container.appendChild(weeklyCard);
            
            // Monthly Report
            const monthlyCard = document.createElement('div');
            monthlyCard.className = 'report-card';
            monthlyCard.innerHTML = '<h3>Monthly Performance</h3>';
            const monthKeys = Object.keys(monthlyStats).sort().reverse().slice(0, 12);
            monthKeys.forEach(key => {
                const [year, month] = key.split('-');
                const date = new Date(parseInt(year), parseInt(month) - 1);
                const label = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                const value = monthlyStats[key];
                monthlyCard.innerHTML += `
                    <div class="report-item">
                        <span class="report-item-label">${label}</span>
                        <span class="report-item-value ${value >= 0 ? 'positive' : 'negative'}">${formatCurrency(value)}</span>
                    </div>
                `;
            });
            container.appendChild(monthlyCard);
            
            // Yearly Report
            const yearlyCard = document.createElement('div');
            yearlyCard.className = 'report-card';
            yearlyCard.innerHTML = '<h3>Yearly Performance</h3>';
            const yearKeys = Object.keys(yearlyStats).sort().reverse();
            yearKeys.forEach(key => {
                const value = yearlyStats[key];
                yearlyCard.innerHTML += `
                    <div class="report-item">
                        <span class="report-item-label">${key}</span>
                        <span class="report-item-value ${value >= 0 ? 'positive' : 'negative'}">${formatCurrency(value)}</span>
                    </div>
                `;
            });
            container.appendChild(yearlyCard);
        }

        // Change month
        function changeMonth(delta) {
            currentMonth.setMonth(currentMonth.getMonth() + delta);
            renderMonthlyCalendar();
        }

        // Change week
        function changeWeek(delta) {
            currentWeek.setDate(currentWeek.getDate() + (delta * 7));
            renderWeeklyView();
        }

        // Navigation handlers
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                
                btn.classList.add('active');
                const viewId = btn.dataset.view + 'View';
                document.getElementById(viewId).classList.add('active');
                
                // Render the appropriate view
                switch (btn.dataset.view) {
                    case 'monthly': renderMonthlyCalendar(); break;
                    case 'weekly': renderWeeklyView(); break;
                    case 'heatmap': renderHeatmap(); break;
                    case 'reports': renderReports(); break;
                }
            });
        });

        // Save URL and load data
        async function saveAndLoad() {
            const url = document.getElementById('sheetUrl').value.trim();
            if (!url) {
                alert('Please enter a Google Sheet CSV URL');
                return;
            }
            
            localStorage.setItem('tradingJournalUrl', url);
            
            const success = await loadData(url);
            if (success) {
                document.getElementById('configPanel').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                renderRunningTotal();
                renderMonthlyCalendar();
            } else {
                alert('Failed to load data. Please check your URL and make sure the sheet is published.');
            }
        }

        // Initialize
        async function init() {
            const savedUrl = localStorage.getItem('tradingJournalUrl');
            if (savedUrl) {
                document.getElementById('sheetUrl').value = savedUrl;
                const success = await loadData(savedUrl);
                if (success) {
                    document.getElementById('configPanel').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';
                    renderRunningTotal();
                    renderMonthlyCalendar();
                }
            }
        }

        // Only auto-init if already authenticated
        if (sessionStorage.getItem('tj_authenticated') === 'true') {
            init();
        }
    </script>
</body>
</html>
